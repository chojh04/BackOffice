<!-- extend base layout -->
{% extends "views/master.html" %}

{% block body %}
<div class="right_col" role="main">
    <div class="">
        <div class="page-title">
            <div class="title_left">
                <h3>KCON 발행내역 조회</h3>
                <h5><span class="red">[홈 > 쿠폰 관리 > KCON 발행내역 조회]</span></h5>
            </div>

        </div>

        <div class="clearfix"></div>

        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_content form ">
                        <form action="#" id="searchForm" class="form-bordered ">
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="col-md-12 col-sm-12 col-xs-12 form-group ">
                                    <label class="control-label col-md-3 col-sm-12 col-xs-12" >- 검색 조건 </label>
                                </div>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="label-top-3 custom-col-lg-2 col-md-2 col-sm-3 col-xs-12">
	                                   <select class="select2_single select2-selection--single " id="dateType" name="dateType" >
	                                   </select>
                                    </label>
                                    <div class="custom-col-lg-8 col-md-12 col-sm-9 col-xs-12 form-inline">
                                    	<input type="text" class="form-control input-date-picker-long" id="startDate" name="startDate" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">쿠폰유형</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
	                                    <select class="form-control" id="prodType" name="prodType" >
	                                    </select>
                                    </div>
                                </div>    
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">쿠폰구분</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
	                                    <select class="form-control" id="couponType" name="couponType" >
	                                    </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="label-top-3 custom-col-lg-2 col-md-2 col-sm-3 col-xs-12">
	                                   <select class="select2_single select2-selection--single " id="orderNoType" name="orderNoType" >
	                                       <option value="1">주문번호</option>
	                                       <option value="2">승인번호</option>	   	                                   	
	                                   </select>
                                    </label>
                                    <div class="custom-col-lg-8 col-md-12 col-sm-12 col-xs-12 form-inline">
	                                    <input type="text" id="orderNo" name="orderNo" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>    
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">사용제한여부</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
	                                    <select class="form-control" id="restrictFlag" name="restrictFlag" >
	                                       <option value="">전체</option>
	                                       <option value="N">N</option>
	                                       <option value="Y">Y</option>	                                    
	                                    </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">사용여부</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
	                                    <select class="form-control" id="useFlag" name="useFlag" >
	                                       <option value="">전체</option>
	                                       <option value="Y">사용</option>
	                                       <option value="N">미사용</option>
	                                    </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">상태</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
	                                    <select class="form-control" id="status" name="status" >
	                                       <option value="">전체</option>
	                                       <option value="0">정상</option>
	                                       <option value="1">폐기</option>	                                    
	                                    </select>
                                    </div>
                                </div>                                
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">쿠폰번호</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
                                    	<input type="text" id="couponNo" name="couponNo" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">쿠폰명</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
                                    	<input type="text" id="title" name="title" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>    
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">권종</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
                                    	<input type="text" id="amount" name="amount" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
                            </div>       
                        </form>
	                    <br />
	                    <table id="kconTable" class="table table-striped table-bordered" style="width: 100%">
                            <thead>
                                <tr>
                                    <th>순번</th>
                                    <th>쿠폰번호</th>
                                    <th>사용여부</th>
                                    <th>쿠폰유형</th>
                                    <th>쿠폰구분</th>
                                    <th>KCON 쿠폰명</th>
                                    <th>POP 쿠폰명</th>
                                    <th>발행일</th>
                                    <th>사용일</th>
                                    <th>사용시간</th>
                                    <th>주문번호</th>
                                    <th>승인번호</th>
                                    <th>유효기간</th>
                                    <th>권종</th>
                                    <th>카드번호</th>
                                    <th>사용제한</th>
                                    <th>상품ID</th>
                                    <th>판매처</th>
                                    <th>연동ID</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>	    
					</div>
				</div>
			</div>                      	
        </div>
    </div>
</div>

{% endblock %}

{% block tail %}
    <!-- datatable lib-->
    <script src="/bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="/bower_components/datatables.net-bs/js/dataTables.bootstrap.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.colVis.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="/bower_components/jszip/dist/jszip.min.js"></script>
    <script src="/bower_components/pdfmake/build/pdfmake.min.js"></script>
    <script src="/bower_components/pdfmake/build/vfs_fonts.js"></script>        
    <script type="text/javascript">

        var kconMng = function () {
            var kconTable;
        	var typeDetailCPCData = { resultList : []};
        	var typeDetailCPTData = { resultList : []};
            
            var setDatePicker = function (){
            	kpcUtil.setDateRangePicker('#startDate');
            }            
            var setSelect2 = function () {
                 $("#restrictFlag,#useFlag,#orderNoType").select2({
                     width: 110,
                 });
             }
            
            var setCommonCode = function (){
      			kpcUtil.setSelectBoxData({
            		target : [
            			 "#prodType",
            			 "#status",
            			 "#dateType",
            		], 
            		apiUrl : "/api/systemMng/common/commonCodeList",
            		params : {type : 'PRTY,CONS,CDAY'},
            		type   : "GET",
            		option : {width : 120},	
            		callBack : function (data,target,option){
            			for(var idx in data){
            				for(var idx2 in data[idx].resultList){
	            				$(target[idx]).append($("<option></option>")
	            						.attr("value" , data[idx].resultList[idx2].code)
	            						.text(data[idx].resultList[idx2].codeName));
            				}
            				$(target[idx]).select2(option);       
            			}
            			
              			kpcUtil.setSelectBoxData({
                    		target : [
                    			 "#couponType",
                    		], 
                    		apiUrl : "/api/systemMng/common/commonCodeList",
                    		params : {type : 'CPC,CPT'},
                    		type   : "GET",
                    		option : {width : 150},	
                    		callBack : function (data,target,option){
                     			setTypeDetailCPCData(data[0].resultList);
                     			setTypeDetailCPTData(data[1].resultList);
                     			settypeDetail(typeDetailCPCData);
                    		}
                    	});              			

            		}
            	});            	
            }                  
        
        var setTypeDetailCPCData = function (data){
        	for(var idx in data){
            	typeDetailCPCData.resultList.push(data[idx]);
        	}
        }
        var setTypeDetailCPTData = function (data){
        	for(var idx in data){
        		typeDetailCPTData.resultList.push(data[idx]);
        	}
        }    
        
        var settypeDetail = function (data , target){
        	$("#couponType").html('');
			for(var idx in data.resultList){
				$("#couponType").append($("<option></option>")
						.attr("value" , data.resultList[idx].code)
						.text(data.resultList[idx].codeName));
			}
			$("#couponType").select2({width : 120});                   	
        }            
        
                       
           
            var setDataTable = function (){
                kconTable = $('#kconTable')
                .dataTable(
                        {
                            "processing": true,
                            "serverSide": true,
                            "deferRender": true,
                            "deferLoading" : 0,
                            "ajax": {
                                "url": "/api/coupon/kcon/kconPublishInq",
                                "contentType" : "application/x-www-form-urlencoded; charset=UTF-8",
                                "async" : "true",
                                "data": function (parameter) {
                                    parameter.formData = $("#searchForm").serializeObject();
                                },
                                "error" : function (e){kpcUtil.sessionExpire(e);}
                            },
                            "ordering": false,
                            "drawCallback": function (settings) {
                                for (var i = 0, iLen = settings.aiDisplay.length; i < iLen; i++) {
                                    $('td:eq(0)', settings.aoData[settings.aiDisplay[i]].nTr).html(i + 1 + settings._iDisplayStart);
                                    settings.json.data[i].rownum = i + 1 + settings._iDisplayStart;
                                }
                            	kpcPopupUtil.setUserTableColumnData({
                            		tableId : "kconTable",
                            		menuId : "{{session['menuId']}}", 
                            		targetTable : kconTable 
                            	});                                
                            },
                            columns: [
                                      {data : "rownum" , defaultContent: "",width : 30, className: "column-align-right"}, // 순번    
                                      {data : "couponNo" , defaultContent: "",width : 60, className: "column-align-right"}, // 쿠폰번호  
                                      {data : "useFlag" , defaultContent: "",width : 60, className: "column-align-center"}, // 사용여부
                                      {data : "prodName" , defaultContent: "",width : 90, className: "column-align-center"}, // 
                                      {data : "couponTypeName" , defaultContent: "",width : 90, className: "column-align-center"},
                                      {data : "title" , defaultContent: "",width : 200, className: "column-align-center"}, // 쿠폰명   
                                      {data : "popCouponName" , defaultContent: "",width : 200, className: "column-align-center"}, // 쿠폰명
                                      {
                                        	data : "issueDate" , 
        	                                defaultContent: "",
        	                                width : 90,
        	                                className: "column-align-center" ,  	                                
        	                                render : function (data, type , full , meta){
        	                                	return kpcUtil.setDateFormat(full.issueDate , "YYYY-MM-DD");
        	                                }
                                       }, // 발행일
                                       {
                                        	data : "useDate" , 
        	                                defaultContent: "",
        	                                width : 90,
        	                                className: "column-align-center" ,  	                                
        	                                render : function (data, type , full , meta){
        	                                	return kpcUtil.setDateFormat(full.useDate , "YYYY-MM-DD");
        	                                }
                                        }, // 사용일
                                        {
                                        	data : "useDate" , 
        	                                defaultContent: "", 
        	                                width : 90,
        	                                className: "column-align-center" ,  	                                
        	                                render : function (data, type , full , meta){
        	                                	return kpcUtil.setDateFormat(full.useDate , "HH:mm:ss");
        	                                }
                                        }, // 사용시간                                                        
                                      {data : "orderNo" , defaultContent: "",width : 150, className: "column-align-center"}, // 거래번호  
                                      {data : "approvalNo" , defaultContent: "",width : 150, className: "column-align-center"}, // 승인번호  
                                      {
                                      	data : "expireDate" , 
      	                                defaultContent: "",
      	                                width : 90,
      	                                className: "column-align-center" ,  	                                
      	                                render : function (data, type , full , meta){
      	                                	return kpcUtil.setDateFormat(full.expireDate , "YYYY-MM-DD");
      	                                }
                                      }, // 유효기간                                      
                                      {
                                        	data : "amount" , 
        	                                defaultContent: "", 
        	                                width : 60,
        	                                className: "column-align-right" ,
        	                                render : function (data, type , full , meta){
        	                                	return kpcUtil.numberWithCommas(full.amount);
        	                                }
                                        },// 권종                                    
                                      {data : "cardNumber" , defaultContent: "",width : 150, className: "column-align-center"}, // 카드번호  
                                      {data : "restrictFlag" , defaultContent: "",width : 60, className: "column-align-center"}, // 사용제한  
                                      {data : "rownum" , defaultContent: "",width : 60, className: "column-align-center"}, // 상품ID  
                                      {data : "rownum" , defaultContent: "",width : 60, className: "column-align-center"}, // 판매처   
                                      {data : "seller" , defaultContent: "",width : 60, className: "column-align-center"}, // 연동ID  
                            ],   
                            buttons: [
                                      {
                                          text: 'Layout',
                                          className: 'btn green btn-outline ',
                                          action: function (e, dt, node, config) {
                                          	kpcPopupUtil.openTableColumnMng({
                                          		columnArray : $(kconTable).find("thead>tr>th").siblings().not(".checkboxes"),
                                          		tableId : "kconTable",
                                          		menuId : "{{session['menuId']}}",
                                          		targetTable : kconTable
                                          	});
                                          }
                                      },
                                      {
                                          text: 'Excel',
                                          className: 'btn yellow btn-outline ',
                                          action: function (e, dt, node, config) {
                                          	if(kpcUtil.confirm("전체 자료를 Excel변환 하시겠습니까?")){
                      							$.ajax({
                      	                            url: "/api/coupon/kcon/kconPublishInq/excelAll",
                      	                            type: 'GET',
                      	                            data : $("#searchForm").serialize(),
                      	                            contentType  : "application/json",
                      	                            async : true,
                      	                            success: function(data){
                      	                            	kpcUtil.customAlert("Excel 변환 요청 성공\n작업 결과는 [시스템관리->배치 작업 조회]페이지에서 확인하세요.");
                      	                            },
                      	                            error : function(e){
                      	                            	kpcUtil.errorHandling(e);
                      	                            }
                      	                       });  	                                    	
                                          	}
                                          }
                                      },
                                      {
                                          text: '조회',
                                          className: 'btn green btn-outline ',
                                          action: function (e, dt, node, config) {
                                        	  kconTable.fnFilter();
                                          }
                                      }
                            ],                            
                            "lengthMenu": [[10, 20, 30, 50, 200], [10, 20, 30, 50, 200]],
                            "pageLength": 10,
                            "dom": "<'row' <'col-md-8 col-sm-12'l><'col-md-4 col-sm-12'B>><'table-scrollable'tr><'row'<'col-md-6 col-sm-6'i><'col-md-6 col-sm-6'p>>",
                            responsive: true,
                            "language": {
                                "aria": {
                                    "sortAscending": ": activate to sort column ascending",
                                    "sortDescending": ": activate to sort column descending"
                                },
                                "info":"Total Record: _TOTAL_ Page : _PAGE_ / _PAGES_ ",
                                "emptyTable": "조회된 자료가 없습니다.",
                                "infoEmpty": "조회된 자료가 없습니다.",
                                "lengthMenu": "_MENU_",
                                "zeroRecords": "조회된 자료가 없습니다."
                            },
                        }
                    );            	
            } 
        	
            var setPageEvents = function (){
				$("#Search").click(function (){
					kconTable.fnFilter();
				});
    			// 조회 이벤트
            	kpcUtil.serachFormEvent({
            		inputs : "#searchForm input",
            		callback : function (){
            			kconTable.fnFilter();
            		}
            	});
           		$("#prodType").change(function (){
       				if($(this).val() == "PRTY-0001"){
       					settypeDetail(typeDetailCPCData);
       				}else{
       					settypeDetail(typeDetailCPTData);
       				}
           		});      			
            }
            
            return {
                init : function (){
                	setDatePicker();
                	setSelect2();
                	setCommonCode();
                	setDataTable();
                    setPageEvents();
                }
            }
        }

        $(document).ready(function () {
            kconMng().init();
        });
    </script>
{% endblock %}