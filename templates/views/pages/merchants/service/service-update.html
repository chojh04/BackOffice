<!-- extend base layout -->
{% extends "views/master.html" %}

{% block body %}
<div class="right_col" role="main">
    <div class="">
        <div class="page-title">
            <div class="title_left">
                <h3>거래처-서비스 수정</h3>
                <h5><span class="red">[홈 > 거래처 관리 > 거래처 조회 > 대표/일반 거래처 조회 > 대표 거래처 상세 > 일반 거래처 상세 > 서비스 수정]</span></h5>
            </div>
        </div>

        <div class="clearfix"></div>

        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="form">
                        <input type="hidden" name="beforeApprEmpId" id="beforeApprEmpId">
                        <input type="hidden" name="beforeReqMemo" id="beforeReqMemo">
                        <form action="#" id="serviceForm" class="form-bordered ">
	                        <input type="hidden" name="reqMemo" id="reqMemo">
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="col-md-12 col-sm-12 col-xs-12 form-group ">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12">- 서비스 정보 </label>
                                </div>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="col-lg-12 col-md-12 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right">
                                    <label class="control-label custom-col-lg-1 col-md-12 col-sm-12 col-xs-12">거래처 코드</label>
                                    <div class="custom-col-lg-10 col-md-3 col-sm-4 col-xs-12 form-inline input-icon left">
	                                    <i class="fa"></i>
                                        <input type="text" id="submerchantId" name="submerchantId" class="form-control col-lg-7" readonly="readonly" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">서비스 코드</label>
                                    <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 form-inline input-icon left">
                                        <input type="text" id="serviceId" name="serviceId" class="form-control col-lg-7" readonly="readonly">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">서비스명</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline input-icon left">
	                                    <i class="fa"></i>
                                        <input type="text" id="serviceName" name="serviceName" class="form-control">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">서비스 타입</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline ">
	                                    <select class="form-control" id="type" name="type" >
	                                    </select>                                        
                                    </div>
                                </div>
								<div
									class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
									<label
										class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">서비스	카테고리</label>
									<div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
										<select class="form-control" id="category" name="category">
										</select>
									</div>
								</div>
								<div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">연동 아이디</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline input-icon left">
                                    	<i class="fa"></i>
										<input type="text" id="svcConnId" name="svcConnId" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">연동 비밀번호</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline input-icon left">
                                    	<i class="fa"></i>
										<input type="password" id="svcConnPw" name="svcConnPw" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
<!--                                 <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">에이전트 아이디</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline input-icon left">
                                    	<i class="fa"></i>
										<input type="text" id="agentId" name="agentId" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">에이전트 비밀번호</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline input-icon left">
                                    	<i class="fa"></i>
										<input type="password" id="agentPw" name="agentPw" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div> -->
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">서비스 사용 여부</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
	                                    <select class="form-control" id="useFlag" name="useFlag" >
	                                    	<option value="Y">사용</option>
	                                    	<option value="N">미사용</option>
	                                    </select>  
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">매출 구분</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
	                                    <select class="form-control" id="saleDivider" name="saleDivider" >
	                                    </select>                                        
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">거래처 경로</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-border-left-lg">
                                        <span id="path" class=" col-md-7 col-xs-12 span-vertical-middle"></span>
                                    </div>
                                </div>
                            </div>
                        </form>
	                    <br />
	                    <div class="column-align-right">
							{% if (admin_view.pageAuth["updFlag"] == "1")  and ((admin_view.reApproval == "true")  and (admin_view.updateApproval == "false")) or ((admin_view.reApproval == "false")  and (admin_view.updateApproval == "false")) %}
							<button type="button" id="updateApprovalRequestBtn" class="dt-button btn green btn-outline"><span>수정</span></button>
							{% elif (admin_view.pageAuth["updFlag"] == "1") and (admin_view.updateApproval == "true") %}
							<a id="updateApprovalInfoBtn" class="dt-button btn green btn-outline" href="javascript:;"><span>수정</span></a>
							{% endif %}
							{% if admin_view.pageAuth["selFlag"] == "1" %}
							<a id="returnListBtn" class="dt-button btn blue btn-outline" href="/merchants/inquiry/merchantServiceInq"><span>목록</span></a>
							{% endif %}
	                    </div>                                
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- 승인요청 modal include -->
{% include 'views/pages/common/approval/popup/approval-request-update-modal.html' %}
{% include 'views/pages/common/approval/popup/approval-request-info-update-modal.html' %}

{% endblock %}

{% block tail %}
    <!-- datatable lib-->
    <script src="/bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="/bower_components/datatables.net-bs/js/dataTables.bootstrap.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.colVis.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="/bower_components/jszip/dist/jszip.min.js"></script>
    <script src="/bower_components/pdfmake/build/pdfmake.min.js"></script>
    <script src="/bower_components/pdfmake/build/vfs_fonts.js"></script>
    <script src="/assets/js/approval/approval.js"></script>
{% if admin_view.pageAuth["insFlag"] == "1" %}
	<script src="/assets/js/approval/merchant/merchant.js"></script>
{% endif %}
    <script type="text/javascript">

  	if ('{{admin_view.pageAuth["updFlag"] == "1"}}' === "False") {
  		$("#updateApprovalRequestBtn").prop("disabled", true);
  	}
	  	
        var merchant_inq = function () {
        	var approvalInfo;
        	var type;
        	var category;
        	var useFlag;
        	var saleDivider;
        	
        	var setSelect2 = function () {
                $("#serviceType").select2({
                    width: 110,
                }); 
                $("#category").select2({
                    width: 110,
                }); 
                
                $("#saleDivider").select2({
                    width: 110,
                }); 
                
                $("#useFlag").select2({
                    width: 110,
                }); 
            }
        	
			//거래처 정보 조회
        	var setViewData = function() {
            	setFormValidate();
            	
            	if(("{{admin_view.reApproval}}" === "false") && ("{{admin_view.updateApproval}}" == "false")) {
            		setServiceInfo();
            	}
            	else if (("{{admin_view.reApproval}}" === "true") || ("{{admin_view.updateApproval}}" == "true")) {
            		setApprovalContentInfo();
            	}
            	
            	setPageEvents();
        	}
			
			var setServiceInfo = function() {
				
    			$.ajax({
    				url: "/api/merchants/services/service",
   					data : "serviceId=" + "{{admin_view.serviceId}}",
                    type:'GET',
                    dataType : "json",
                    contentType  : "application/json",
                }).done(function(result){
					console.log(result)
                	$("#submerchantId").val(result.submerchantId); //거래처코드
                	$("#serviceId").val(result.serviceId); //서비스 코드
                	$("#serviceName").val(result.name); //서비스명 
                	$("#type").val(result.serviceType); //서비스 타입
                	$("#category").val(result.category); //서비스 카테고리
                	
                	$("#svcConnId").val(result.svcConnId); // 연동 아이디
                	$("#svcConnPw").val(result.svcConnPw); // 연동 아이디 비밀번호
               	 	
                	$("#useFlag").val(result.useFlag); //사용여부
                	$("#path").text(result.path); // 경로
                	
                	serviceType = result.serviceType;
                	category = result.category;
                	saleDivider = result.saleDivider;
                	useFlag = result.useFlag;
                	
        			setCommonCode();

                	$("#serviceForm").valid();
                
                }).fail(function(e){
            		kpcUtil.errorHandling(e);
          	    });
			}
			
			var setApprovalContentInfo = function() {
	    		$.ajax({
	                url: "/api/approvals/detail/"+"{{admin_view.apprSeq}}",
	                type:'GET',
	                dataType : "json",
	                contentType  : "application/json",
	            }).done(function(result){
	            	if (result.status === 200) {
    	            	
	            		approvalInfo = result.data.approvalInfo;
	            		var service = result.data.content.service;
	            		
	            		$("#submerchantId").val(service.subMerchantId);
	            		$("#serviceId").val(service.serviceId);
	            		$("#serviceName").val(service.name);
	            		$("#svcConnId").val(service.svcConnId);
	            		$("#svcConnPw").val(service.svcConnPw);
	            		
	            		type = service.type
	            		category = service.category
	            		useFlag = service.useFlag
	            		saleDivider = service.saleDivider
	            		
	            		setSubMerchantPath(service.subMerchantId);

	                	$("#beforeApprEmpId").val(approvalInfo.apprEmpId); // 선택한 승인자
	                	$("#beforeReqMemo").val(approvalInfo.reqMemo); // 승인 요청 사유
	                	
	        			setCommonCode();
                	}
        			setCommonCode();
                	$("#serviceForm").valid();
	            	
	            }).fail(function(e){
	        		kpcUtil.errorHandling(e);
	      	    });
			}
			
            var setSubMerchantPath = function(subMerchantId) {
   	    		$.ajax({
   	                url: "/api/merchants/sub-merchant/"+subMerchantId+"/path",
   	                type:'GET',
   	                dataType : "json",
   	                contentType  : "application/json",
   	            }).done(function(result){
   	            	if (result.status === 200) {
   	            		$("#path").text(result.data.path)
                   	}   	            	
   	            }).fail(function(e){
   	        		kpcUtil.errorHandling(e);
   	      	    });
            }
			
			//필수 입력값 유효성 검증
        	function setFormValidate(){
        	    $("#serviceForm").validate({
        	        errorElement: 'span', //default input error message container
        	        errorClass: 'help-block help-block-error', // default input error message class
                    rules: {
                    	submerchantId : {
                            required : true,
                        },
                        serviceName: {
                            required : true,
                        },
						svcConnId: {
                            required : true,
                            svcConnIdDupCheck : true
                        },
						svcConnPw: {
                            required : true,
                        },
						agentId: {
                            required : true,
                        },
						agentPw: {
                            required : true,
                        },
                    },
                    messages : {
                    	submerchantId : {
                            required : "잘못된 접근입니다.",
                        },
                        serviceName: {
                            required : "서비스명을 입력해주세요..",
                        },
						svcConnId: {
                            required : "연동 아이디를 입력해주세요.",
                            svcConnIdDupCheck : "사용중인 연동 ID 입니다."
                        },
						svcConnPw: {
                            required : "연동 비밀번호를 입력해주세요.",
                        },
						agentId: {
                            required : "에이전트 아이디를 입력해주세요.",
                        },
						agentPw: {
                            required : "에이전트 비밀번호를 입력해주세요",
                        },
        	        },
        	        errorPlacement : function (error , element){
        	        	var icon = $(element).parent(".input-icon").children('i');
        	        	icon.removeClass('fa-check').addClass("fa-warning");
        	        	icon.attr("data-original-title" , error.text()).tooltip({"container" : "body"});
        	        },
        	        highlight: function (element) { // hightlight error inputs
        	           	$(element).closest('.form-group').addClass('has-error'); // set error class to the control group
        	        },
        	        success : function (label,element){
        	        	var icon = $(element).parent(".input-icon").children('i');
        	        	$(element).closest(".form-group").removeClass("has-error").addClass("has-success");
        	        	icon.removeClass('fa-warning').addClass("fa-check");
        	        },
        	    });
        	}
            
            
            var setPageEvents = function (){
            	$("#returnListBtn").click(function (){
            		//history.back();
            		location.href = "/merchants/inquiry/merchantServiceInq";
            	});            	
            }
            
			
            var setCommonCode = function (){
      			kpcUtil.setSelectBoxData({
            		target : "#type", 
            		apiUrl : "/api/systemMng/common/commonCodes",
            		params : {type : 'SVRT'},
            		type   : "GET",
            		option : {width : 150},	
            		callBack : function (data,target,option){

            			for(var idx in data.data){
            				$(target).append($("<option></option>")
            						.attr("value" , data.data[idx].code)
            						.text(data.data[idx].codeName));
            			}
            			//서비스 타입 값 설정
            			if (type !== undefined) {
	            			$(target).val(type).trigger("change");          
            			}
            		}
            	});
      			kpcUtil.setSelectBoxData({
            		target : "#category", 
            		apiUrl : "/api/systemMng/common/commonCodes",
            		params : {type : 'SVRT'},
            		type   : "GET",
            		option : {width : 150},	
            		callBack : function (data,target,option){

            			for(var idx in data.data){
            				$(target).append($("<option></option>")
            						.attr("value" , data.data[idx].code)
            						.text(data.data[idx].codeName));
            			}
            			//서비스 카테고리 값 설정
            			if (category !== undefined) {
	            			$(target).val(category).trigger("change");          
            			}
            		}
            	});      			
      			kpcUtil.setSelectBoxData({
            		target : "#saleDivider", 
            		apiUrl : "/api/systemMng/common/commonCodes",
            		params : {type : 'SVC'},
            		type   : "GET",
            		option : {width : 150},	
            		callBack : function (data,target,option){

            			for(var idx in data.data){
            				$(target).append($("<option></option>")
            						.attr("value" , data.data[idx].code)
            						.text(data.data[idx].codeName));
            			}
            			//매출 구분 값 설정
            			if (saleDivider !== undefined) {
	            			$(target).val(saleDivider).trigger("change");          
            			}
            		}
            	});      			
      			//사용여부 값 설정
      			$("#useFlag").val(useFlag).trigger("change");
            }            
            
            return {
                init : function (){
                    setViewData();
                    setSelect2();
                }
            }
        }

        $(document).ready(function () {
            
            merchant_inq().init();
            //임포트한 수정 승인 요청 모달 초기화
            approvalReuestUpdateModal("{{admin_view.merchantId}}", "serviceForm", "MENU-0001", "AWRK-0003"); //거래처 수정 승인 요청 모달
            approvalReuestInfoUpdateModal("{{admin_view.apprSeq}}", "serviceForm", "MENU-0001", "update", "AWRK-0003"); //승인 대기중인 거래처 정보 수정 모달
        });

    </script>
{% endblock %}