<!-- extend base layout -->
{% extends "views/master.html" %}

{% block body %}
<div class="right_col" role="main">
    <div class="">
        <div class="page-title">
            <div class="title_left">
                <h3>거래처 서비스 조회</h3>
                <h5><span class="red">[홈 > 거래처 관리 > 거래처 조회 > 거래처 서비스 조회]</span></h5>
            </div>
        </div>
        <div class="clearfix"></div>
                                                                                                      
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_content form">
                        <form action="#" id="services" class="form-bordered ">
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="col-md-12 col-sm-12 col-xs-12 form-group ">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">- 검색 조건 </label>
                                </div>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" for="first-name">서비스명</label>
                                    <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 form-inline">
										<input type="text" id="name" name="name" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" for="first-name">상태</label>
                                    <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 ">
	                                    <select class="select2_single select2-selection--single form-control" id="useFlag" name="useFlag" >
	                                        <option value="">전체</option>
	                                        <option value="Y">사용</option>
	                                        <option value="N">미사용</option>
	                                    </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" for="first-name">서비스 코드</label>
                                    <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 form-inline">
										<input type="text" id="serviceId" name="serviceId" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12" for="first-name">서비스 타입</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
	                                    <select class="select2_single select2-selection--single form-control" id="serviceType" name="serviceType" >
	                                    	<option value="">전체</option>
	                                    </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12" for="first-name">소속 거래처명</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
										<input type="text" id="merchantName" name="merchantName" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12" for="first-name">정산</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
	                                    <select class="select2_single select2-selection--single form-control" id="billingRegFlag" name="billingRegFlag" >
	                                        <option value="">전체</option>
	                                        <option value="Y">등록</option>
	                                        <option value="N">미등록</option>
	                                    </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12" for="first-name">연동 아이디명</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
										<input type="text" id="svcConnId" name="svcConnId" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
                            </div>
                        </form>
                        <br />
                        <table id="merchantServiceInqTable" class="table table-striped table-bordered" style="width: 100%" >
                            <thead>
                                <tr>
                                    <th>순번</th>
                                    <th>소속 거래처</th>
                                    <th>서비스 ID</th>
                                    <th>서비스명</th>
                                    <th>연동 아이디</th>
                                    <th>서비스 타입</th>
                                    <th>상태</th>
                                    <th>서비스</th>
                                    <th>정산명</th>
                                    <th>정산</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- modal include -->
{% include 'views/pages/common/merchant/popup/service-billing-detail-modal.html' %}

{% endblock %}

{% block tail %}
    <!-- datatable lib-->
    <script src="/bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="/bower_components/datatables.net-bs/js/dataTables.bootstrap.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.colVis.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="/bower_components/jszip/dist/jszip.min.js"></script>
    <script src="/bower_components/pdfmake/build/pdfmake.min.js"></script>
    <script src="/bower_components/pdfmake/build/vfs_fonts.js"></script>
    <script src="/assets/js/merchant.js"></script>
{% if admin_view.pageAuth["updFlag"] == "1" %}
	<script src="/assets/js/approval/merchant/billing.js"></script>
{% endif %}
    <script src="/assets/js/approval/approval.js"></script>        
    <script type="text/javascript">

        var merchant_inq = function () {
        	var table = {};

            var setSelect2 = function () {
                $("#useFlag").select2({
                    width: 110,
                });
                $("#billingRegFlag").select2({
                    width: 110,
                });
            }
            var setDataTable = function () {
            	table = $('#merchantServiceInqTable')
                .on('click', '.merchantDet', function () {
                	location.href = "/merchants/merchant/merchantDetail?merchantId=" + $(this).attr("submerchantid");
                })
                .on('click', '.det', function () {
                	location.href = "/merchants/service/merchantServiceDetail?serviceId=" + $(this).attr("serviceId");
                })
                {% if admin_view.pageAuth["updFlag"] == "1" %}
                .on('click', '.upt', function () {
               		var isExist = approval.existApprovalRequest($(this).attr("serviceId"));
               		if (!isExist) {
	                	location.href = "/merchants/sub-merchant/service/update?serviceId="+$(this).attr("serviceId")+"&subMerchantId="+$(this).attr("submerchantid");
               		}
                })                                    
                {% endif %}
                .on('click', '.detBilling', function () {
                	serviceBillingDetailModal("billing", ($(this).attr("billingid")));
                	/* 
			   		kpcUtil.openCommonPopup({
			   			modalTitle : "정산 상세",
			   			modalSize : "modal-full",
			   			modalType : "URL",
			   			URL : "/merchants/service/merchantBillingDetail?serviceBillingId=" + $(this).attr("billingid"),
			   			method : "GET",		   			
			   		});
			   		 */
                })
                {% if admin_view.pageAuth["updFlag"] == "1"%}
                .on('click', '.uptBilling', function () {
               		var isExist = approval.existApprovalRequest($(this).attr("billingid"));

               		if (!isExist) {
	                	location.href = "/merchants/sub-merchant/service/billing/update?serviceBillingId="+$(this).attr("billingid");
               		}
                	
                	//billingUpdate($(this).attr("billingid"),function (){ table.fnFilter()});
                })                                    
                {% endif %}
                {% if admin_view.pageAuth["insFlag"] == "1" %}
                .on('click', '.regBilling', function () {
                	location.href = "/merchants/service/merchantBillingReg?serviceId=" + $(this).attr("serviceId") + "&submerchantId=" + $(this).attr("submerchantId");
                })
                {% endif %}
                .dataTable(
                    {
                        "processing": true,
                        "serverSide": true,
                        "ajax": {
                            "url": "/api/merchants/services",
                            "async" : "true",
                            "data": function (parameter) {
                            	parameter.formData = $("#services").serializeObject();        
                            },
                            "error" : function (e){kpcUtil.sessionExpire(e);}
                        },
                        "ordering": false,
                        "drawCallback": function (settings) {
                            for (var i = 0, iLen = settings.aiDisplay.length; i < iLen; i++) {
                                $('td:eq(0)', settings.aoData[settings.aiDisplay[i]].nTr).html(i + 1 + settings._iDisplayStart);
                                settings.json.data[i].rownum = i + 1 + settings._iDisplayStart;
                            }
                            if(settings.aiDisplay.length > 0){
                            	$("#serviceReg").text("서비스추가");
                            }
                            
                        	kpcPopupUtil.setUserTableColumnData({
                        		tableId : "merchantServiceInqTable",
                        		menuId : "{{session['menuId']}}", 
                        		targetTable : table
                        	});
                        },
                        columns: [
                            {data: "rownum", defaultContent: "", width: 80 , className: "column-align-right"},     // 순번
                            {
                            	data : "merchantName" ,
                                defaultContent: "", 
                                className: "column-align-center",
                                render : function (data, type , full , meta){
                                	return '<a class="blue merchantDet" href="javascript:;" serviceId="' + full.serviceId + '" submerchantId="' + full.submerchantId + '">' + full.merchantName + '</a>';
                                }
                            },  // 서비스명  
                            {data: "serviceId", defaultContent: "",className: "column-align-center"},              // 서비스 아이디
                            {
                            	data : "name" ,
                                defaultContent: "", 
                                className: "column-align-center",
                                render : function (data, type , full , meta){
                                	return '<a class="blue det" href="javascript:;" serviceId="' + full.serviceId + '" submerchantId="' + full.submerchantId + '">' + full.name + '</a>';
                                }
                            },  // 서비스명                                     
                            {data: "svcConnId", defaultContent: "",className: "column-align-center"},          // 연동아이디
                            {data: "typeName", defaultContent: "",className: "column-align-center"},          // 서비스타입
                            {data: "useFlagName", defaultContent: "",className: "column-align-center"},               // 상태
                            {
                            	data : "service" ,
                                defaultContent: "", 
                                width : 90,
                                className: "column-align-center",
                                render : function (data, type , full , meta){
                                    // 수정 버튼
                                    var html = "";
                                	var btnDisabled = "" ;
 	                                	if ('{{admin_view.pageAuth["updFlag"] == "1"}}' === "False") {
 	                                		btnDisabled = "disabled";
 	                                	}
                                    html = '<button type="button"  class="btn btn-sm green btn-outline upt" serviceId="' + full.serviceId + '" submerchantId="'+full.submerchantId+' " '+btnDisabled+'  ">수정</button>';
                                	return html;
                                }
                            },  // 수정 
                            {
                            	data : "billingName" ,
                                defaultContent: "", 
                                className: "column-align-center",
                                render : function (data, type , full , meta){
                                    var html = "";
                                    {% if admin_view.pageAuth["selFlag"] == "1" %}
	                                    if(kpcUtil.nullToBlank(full.billingName) != "")
	                                    	html = '<a class="blue detBilling" href="javascript:;" billingId="' + full.serviceBillingId + '">' + full.billingName + '</a>';
                                    {% endif %}                                	
                               		return html;
                                }
                            },  // 정산명                                 
                            {
                            	data : "serviceBillingId" ,
                                defaultContent: "", 
                                width : 90,
                                className: "column-align-center",
                                render : function (data, type , full , meta){
                                	var html= '';
                                	if(kpcUtil.nullToBlank(full.serviceBillingId) !== ""){
                                		{% if admin_view.pageAuth["updFlag"] == "1"%}
                                		html = '<button type="button" class="btn btn-sm green btn-outline uptBilling" href="javascript:;" billingId="' + full.serviceBillingId +'" updateType=billing  ">수정</button>';
	                                	{% endif %}
                                		return html;
                                	}
                                	else{ 
	                                	{% if admin_view.pageAuth["insFlag"] == "1" %}
	                                		html = '<button type="button" class="btn btn-sm blue btn-outline regBilling" href="javascript:;" serviceId="' + full.serviceId + '" submerchantId="'+full.submerchantId+'">등록</button>';
	                                	{% endif %}
                                		return html;
                                	}
                                }
                            },  // 수정                                
                        ],
                        buttons: [
                                {
                                	text: 'Layout',
                                    className: 'dt-button btn green btn-outline ',
                                    action: function (e, dt, node, config) {
                                    	kpcPopupUtil.openTableColumnMng({
    							    		columnArray : $(table).find("thead>tr>th").siblings().not(".checkboxes"),
    							    		tableId : "merchantServiceInqTable",
    							    		menuId : "{{session['menuId']}}",
    							    		targetTable : table
        								}); 
                                    }
                                },
                                {extend: 'excel', className: 'btn yellow btn-outline ', footer: true}, 
                                {
                                    text: '조회',
                                    className: 'btn green btn-outline ',
                                    action: function (e, dt, node, config) {
                                        table.fnFilter();
                                    }
                                }
                            ],                        
                        "lengthMenu": [[10, 20, 30, 50, 200], [10, 20, 30, 50, 200]],
                        "pageLength": 10,
                        "dom": "<'row' <'col-md-6 col-sm-12'l><'col-md-6 col-sm-12'B>><'table-scrollable'tr><'row'<'col-md-6 col-sm-6'i><'col-md-6 col-sm-6'p>>",
                        responsive: true,
                        "language": {
                            "aria": {
                                "sortAscending": ": activate to sort column ascending",
                                "sortDescending": ": activate to sort column descending"
                            },
                            "info":"Total Record: _TOTAL_ Page : _PAGE_ / _PAGES_ ",
                            "emptyTable": "조회된 자료가 없습니다.",
                            "infoEmpty": "조회된 자료가 없습니다.",
                            "lengthMenu": "_MENU_",
                            "zeroRecords": "조회된 자료가 없습니다."
                        },
                    }
                );
            }
            
            var setPageEvents = function (){
    			// 조회 이벤트
            	kpcUtil.serachFormEvent({
            		selects : "#services select",
            		inputs : "#services input",
            		callback : function (){
            			table.fnFilter();
            		}
            	});            	
            }
            
            var setCommonCode = function (){
      			kpcUtil.setSelectBoxData({
            		target : "#serviceType", 
            		apiUrl : "/api/systemMng/common/commonCodes",
            		params : {type : 'SVRT'},
            		type   : "GET",
            		option : {width : 150},	
            		callBack : function (data,target,option){
            			for(var idx in data.data){
            				$(target).append($("<option></option>")
            						.attr("value" , data.data[idx].code)
            						.text(data.data[idx].codeName));
            			}
            			$(target).select2(option);      
            			setDataTable();
            		}
            	});            
            }
            
            return {
                init : function (){
                    setSelect2();
                    setCommonCode();
                    setPageEvents();
                    // TODO : setDatatable call at setCommonCode callback function  
                    // setDataTable();  
                }
            }
        }

        $(document).ready(function () {
            merchant_inq().init();
            serviceBillingDetailModalInit();
        });
    </script>
{% endblock %}