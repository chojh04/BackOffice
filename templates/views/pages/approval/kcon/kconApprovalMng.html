<!-- extend base layout -->
{% extends "views/master.html" %}

{% block body %}
<div class="right_col" role="main">
    <div class="">
        <div class="page-title">
            <div class="title_left">
                <h3>상품 승인 관리</h3>
                <h5><span class="red">[홈 > 승인 관리 > 상품 승인 관리]</span></h5>
            </div>

        </div>

        <div class="clearfix"></div>

        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_content form">
                        <form action="#" id="searchForm" class="form-bordered ">
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="col-md-12 col-sm-12 col-xs-12 form-group ">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12" >- 검색 조건 </label>
                                </div>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" >상품명</label>
                                    <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 form-inline">
	                                    <input type="text" id="title" name="title" class="form-control col-md-7 col-xs-12">                                    
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" >상품유형</label>
                                    <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 form-inline">
										<select class="form-control" id="type" name="type" >
	                                    	<option value="">전체</option>
	                                    </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" >상품유형상세</label>
                                    <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 form-inline">
	                                    <select class="form-control" id="typeDetail" name="typeDetail" >
	                                    	<option value="">전체</option>
	                                    </select>                                    
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">신청자</label>
                                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">
										<input type="text" id="reqEmpName" name="reqEmpName" class="form-control col-md-7 col-xs-12" maxlength="12">
                                    </div>
                                    
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" >처리구분</label>
                                    <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 form-inline">
	                                    <select class="form-control" id="status" name="status" >
	                                    	<option value="">전체</option>
	                                    </select>                                                           
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">
                                    <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" >기간</label>
                                    <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 form-inline">
										<input type="text" class="form-control input-date-picker-long" id="startDate" name="startDate" >
                                    </div>
                                </div>
                            </div>
                        </form>
                        <br />
                        <table id="approvalTable" class="table table-striped table-bordered" >
                            <thead>
                                <tr>
                                    <th>순번</th>
                                    <th class="column-align-center">
                                   		선택
                                   		<br />
                                    	<label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">
                                    		<input type="checkbox" class="group-checkable selGroup" data-set="#approvalTable .selCheckboxes" />
                                    		<span></span>
                                    	</label>
                                    </th>                                    
                                    <th>상태</th>
                                    <th>처리구분</th>
                                    <th>신청일</th>
                                    <th>처리일</th>
                                    <th>상품유형</th>
                                    <th>상품유형상세</th>
                                    <th>KCON상품명</th>
                                    <th>신청자</th>
                                    <th>승인자</th>
                                    <th>보기</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block tail %}
    <!-- datatable lib-->
    <script src="/bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="/bower_components/datatables.net-bs/js/dataTables.bootstrap.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.colVis.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="/bower_components/jszip/dist/jszip.min.js"></script>
    <script src="/bower_components/pdfmake/build/pdfmake.min.js"></script>
    <script src="/bower_components/pdfmake/build/vfs_fonts.js"></script>
    <script type="text/javascript">

        var userMenuMng_inq = function () {
        	var table = {};
        	var typeDetailCPCData = { resultList : []};
        	var typeDetailCPTData = { resultList : []};
        	var typeDetailAllData = { resultList : []};
            var setSelect2 = function () {

            }
            
            var setDatePicker = function (){
            	kpcUtil.setDateRangePicker('#startDate');
            }            
            
            var setCommonCode = function (){
      			kpcUtil.setSelectBoxData({
            		target : [
            			 "#searchForm #type",
            			 "#searchForm #status"
            		], 
            		apiUrl : "/api/systemMng/common/commonCodeList",
            		params : {type :'PRTY,ARST'},
            		type   : "GET",
            		option : {width : 110},	
            		callBack : function (data,target,option){
            			for(var idx in data){
            				for(var idx2 in data[idx].resultList){
	            				$(target[idx]).append($("<option></option>")
	            						.attr("value" , data[idx].resultList[idx2].code)
	            						.text(data[idx].resultList[idx2].codeName));
            				}
            				$(target[idx]).select2(option);       
            			}
              			kpcUtil.setSelectBoxData({
                    		target : [
                    			 "#searchForm #typeDetail",
                    		], 
                    		apiUrl : "/api/systemMng/common/commonCodeList",
                    		params : {type :'CPC,CPT'},
                    		type   : "GET",
                    		option : {width : 150},	
                    		callBack : function (resultData,target,option){
                    			setTypeDetailCPCData(resultData[0].resultList);
                    			setTypeDetailCPTData(resultData[1].resultList);
                    			setTypeDetailAllData(resultData[0].resultList);
                    			setTypeDetailAllData(resultData[1].resultList);
                    			settypeDetail(typeDetailAllData);
		            			setDataTable();
                    		}
                    	});            		            			
            		}
            	});             	
         	
            }
            var setTypeDetailCPCData = function (data){
            	for(var idx in data){
	            	typeDetailCPCData.resultList.push(data[idx]);
            	}
            }
            var setTypeDetailCPTData = function (data){
            	for(var idx in data){
            		typeDetailCPTData.resultList.push(data[idx]);
            	}
            }
            var setTypeDetailAllData = function (data){
            	for(var idx in data){
            		typeDetailAllData.resultList.push(data[idx]);
            	}            	
            }     
            
            var settypeDetail = function (data , target){
            	$("#searchForm #typeDetail").html('');
				$("#searchForm #typeDetail").append($("<option></option>")
						.attr("value" , "")
						.text("전체"));
				for(var idx in data.resultList){
    				$("#searchForm #typeDetail").append($("<option></option>")
    						.attr("value" , data.resultList[idx].code)
    						.text(data.resultList[idx].codeName));
				}
				$("#searchForm #typeDetail").select2({width : 120});                   	
            }            
            
            var settypeUpdDetail= function (data , target){
            	$("#couponUpdForm #typeDetail").html('');
            	console.log(data);
				for(var idx in data.resultList){
    				$("#couponUpdForm #typeDetail").append($("<option></option>")
    						.attr("value" , data.resultList[idx].code)
    						.text(data.resultList[idx].codeName));
				}
				$("#couponUpdForm #typeDetail").select2({width : 120});                   	
            }             
            
            var apprDetailContent = function (){
            	 return'<br />'
				 +'<form action="#" id="detailForm" class="form-bordered ">'
                 +'	<div class="col-md-12 col-sm-12 col-xs-12">'
                 +'        <div class="col-md-12 col-sm-12 col-xs-12 form-group ">'
                 +'        </div>'
                 +' 	</div>	'
                 +'    <div class="col-md-12 col-sm-12 col-xs-12">'
                 +'        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right">'
                 +'            <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" >상품 ID</label>'
                 +'            <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 span-vertical-middle">'
     			 +'				<span id="productId" class="form-border-left-lg col-md-7 col-xs-12 span-vertical-middle" ></span>'
                 +'            </div>'
                 +'        </div>'
                 +'        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">'
                 +'            <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" >상품명</label>'
                 +'            <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 span-vertical-middle">'
     			 +'				<span id="title" class="form-border-left-lg col-md-7 col-xs-12 span-vertical-middle"></span>'
                 +'            </div>'
                 +'        </div>'
                 +'    </div>'
                 +'    <div class="col-md-12 col-sm-12 col-xs-12">'
                 +'        <div class="col-md-12 col-sm-12 col-xs-12 form-group ">'
                 +'            <label class="control-label col-md-3 col-sm-3 col-xs-12" ><b>[쿠폰 상품 속성]</b></label>'
                 +'        </div>'
                 +'    </div>	'
                 +'  	<div class="col-md-12 col-sm-12 col-xs-12">'
     			 +'		<div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">'
     			 +'		    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">상품유형</label>'
     			 +'		    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 span-vertical-middle">'
     			 +'				<span id="typeCodeNm" class="form-border-left-lg col-md-7 col-xs-12 span-vertical-middle"></span>'
     			 +'		    </div>'
     			 +'		</div>'
     			 +'		<div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">'
     			 +'		    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">상품유형상세</label>'
     			 +'		    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 span-vertical-middle">'
     			 +'				<span id="typeDetailNm" class="form-border-left-lg col-md-7 col-xs-12 span-vertical-middle"></span>'
     			 +'		    </div>'
     			 +'		</div>	'
     			 +'		<div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">'
     			 +'		    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">권종</label>'
     			 +'		    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 span-vertical-middle">'
     			 +'				<span id="amount" class="form-border-left-lg col-md-7 col-xs-12 span-vertical-middle"></span>'
     			 +'		    </div>'
     			 +'		</div>'
     			 +'		<div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">'
     			 +'		    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">유효기간 설정</label>'
     			 +'		    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 span-vertical-middle">'
     			 +'				<span id="expireDaysTypeName" class="form-border-left-lg col-md-7 col-xs-12 span-vertical-middle"></span>'
     			 +'		    </div>'
     			 +'		</div>'
     			 +'		<div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right">'
     			 +'		    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">상품등록자</label>'
     			 +'		    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 span-vertical-middle">'
     			 +'				<span id="register" class="form-border-left-lg col-md-7 col-xs-12 span-vertical-middle"></span>'
     			 +'		    </div>'
     			 +'		</div>'
     			 +'		<div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">'
     			 +'		    <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">사유</label>'
     			 +'		    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 span-vertical-middle">'
     			 +'				<span id="apprDesc" class="form-border-left-lg col-md-7 col-xs-12 span-vertical-middle"></span>'
     			 +'		    </div>'
     			 +'		</div>'
     			 +'	</div>'
     			 +'</form>';            	
            }
            var apprUpdateContent = function (){
           	 return'<br />'
                 +'<form action="#" id="couponUpdForm" class="form-bordered ">'
                 +'    <div class="col-md-12 col-sm-12 col-xs-12">'
                 +'        <div class="col-md-12 col-sm-12 col-xs-12 form-group ">'
                 +'        </div>'
                 +'    </div>	'
                 +'    <div class="col-md-12 col-sm-12 col-xs-12">'
                 +'        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">'
                 +'            <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" >상품 ID</label>'
                 +'            <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 form-inline">'
	             +'				<input type="text" id="productId" name="productId" class="form-control col-md-7 col-xs-12" readonly="readonly">'
                 +'            </div>'
                 +'        </div>'
                 +'        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs ">'
                 +'            <label class="control-label col-lg-3 col-md-12 col-sm-3 col-xs-12" >상품명</label>'
                 +'            <div class="col-lg-9 col-md-12 col-sm-9 col-xs-12 form-inline input-icon left">'
                 +'            	<i class="fa"></i>'
	             +'				<input type="text" id="title" name="title" class="form-control col-md-7 col-xs-12">'
                 +'            </div>'
                 +'        </div>'
                 +'    </div>'
                 +'    <div class="col-md-12 col-sm-12 col-xs-12">'
                 +'        <div class="col-md-12 col-sm-12 col-xs-12 form-group ">'
                 +'            <label class="control-label col-md-3 col-sm-3 col-xs-12" ><b>[쿠폰 상품 속성]</b></label>'
                 +'        </div>'
                 +'    </div>	'
                 +'	<div class="col-md-12 col-sm-12 col-xs-12">'
                 +'        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">'
                 +'            <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">상품유형</label>'
                 +'            <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 md-radio-inline">'
                 +'            	<div class="md-radio">'
                 +'            		<input type="radio" id="type1" name="typeCode" value="PRTY-0001" >'
                 +'            		<label for="type1">'
                 +'            			<span></span>'
                 +'            			<span class="check"></span>'
                 +'            			<span class="box"></span>'
                 +'            			충전쿠폰'
                 +'            		</label>'
                 +'            	</div>'
                 +'            	<div class="md-radio">'
                 +'            		<input type="radio" id="type2" name="typeCode" value="PRTY-0002" >'
                 +'            		<label for="type2">'
                 +'            			<span></span>'
                 +'            			<span class="check"></span>'
                 +'            			<span class="box"></span>'
                 +'            			교환쿠폰'
                 +'            		</label>'
                 +'            	</div>'
                 +'            </div>'
                 +'        </div>'
                 +'        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">'
                 +'            <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">상품유형상세</label>'
                 +'            <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">'
                 +'                <select class="form-control" id="typeDetail" name="typeDetail"  >'
                 +'                </select>'
                 +'            </div>'
                 +'        </div>	'
                 +'        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">'
                 +'            <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">권종</label>'
                 +'            <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline input-icon left">'
                 +'            	<i class="fa"></i>'
                 +'                <input type="text" id="amount" name="amount" class="form-control col-md-7 col-xs-12" >'
                 +'                <span class="table-span-vertical">&nbsp;원</span>'
                 +'            </div>'
                 +'        </div>'
                 +'        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">'
                 +'            <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">유효기간 설정</label>'
                 +'            <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">'
                 +'                <span class="span-float-left">'
                 +'                    <select class="form-control" id="expireDaysType" name="expireDaysType" >'
                 +'                    	<option value="">선택</option>'
                 +'                    </select>'
                 +'                </span>'
                 +'                <span class="span-float-left-margin">발행일로부터</span>'
                 +'                <span class="span-unput-float-left">'
	             +'					&nbsp;<input type="text" id="expireDays" name="expireDays" class="form-control input-xxsmall" maxlength="5">'
	             +'				</span>'
                 +'                <span class="span-float-left-margin" id="dateTypeText">&nbsp;일</span>'
                 +'            </div>'
                 +'        </div>'
                 +'        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-left form-border-right ">'
                 +'            <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">사용처</label>'
                 +'            <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline input-icon left">'
                 +'            	    <i class="fa"></i>'
                 +'                 <select class="form-control" id="usage" name="usage" >'
                 +'                	    <option value="전체">전체</option>'
                 +'                	    <option value="온라인">온라인</option>'
                 +'                	    <option value="오프라인">오프라인</option>'
                 +'                 </select>'
                 +'            </div>'
                 +'        </div>'
                 +'        <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12 form-group form-border-right form-border-left-xs">'
                 +'            <label class="control-label col-lg-3 col-md-12 col-sm-12 col-xs-12">상품등록자</label>'
                 +'            <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12 form-inline">'
	             +'				<input type="text" id="register" name="register" class="form-control col-md-7 col-xs-12" readonly="readonly">'
                 +'            </div>'
                 +'        </div>'
                 +'   	</div>'
                 +'</form>'
 	             +'<br/>';            	
           }            
            
            var setDataTable = function () {
           	// 발행 중지/ 발행중지 해제  삭제 작업 필요!!
            	table = $('#approvalTable')
                    .on('click','.det', function () {
                    	var seq = $(this).attr("seq");
                    	var tmpSeq = $(this).attr("tmpSeq");
                    	var status = $(this).attr("status");
                    	var reqEmpId = $(this).attr("reqEmpId");
                    	var apprEmpId = $(this).attr("apprEmpId");
                    	var typeCode = $(this).attr("typeCode");

				   		var buttonHtml ='';
				   		var bodyHtml ='';

				   		if(status == "ARST-0001"&& apprEmpId == "{{session['empId']}}"){
 							bodyHtml = apprDetailContent();   				   			
 				   			buttonHtml ='<button type="button" class="dt-button btn green btn-outline btnAppr">승인처리</button>'
				   		               +'<button type="button" class="dt-button btn green btn-outline btnReject">반려</button>';
				   		} else if(status == "ARST-0003" && reqEmpId == "{{session['empId']}}" && typeCode == "APPR-0500"){
				   			buttonHtml ='<button type="button" class="dt-button btn green btn-outline btnUpt">수정</button>';
		            		bodyHtml = apprUpdateContent();
				   		} else{
				   			bodyHtml = apprDetailContent();
				   		}
				   		kpcUtil.openCommonPopup({
				   			modalTitle : "상세 정보",
				   			bodyHtml : bodyHtml,
				   			button : buttonHtml,
				   			modalSize : "custom-lg-modal-body",
				   			buttonEvent : [{
				   				target : ".btnAppr",
				   				eventType : "click",
				   				callBack : function (){
				   					if(kpcUtil.confirm("승인 하시겠습니까?")){
				   						$.ajax({
					                        url: "/api/approval/kcon/approvals/approval",
					                        data: JSON.stringify({"seq" : seq , "tmpSeq" : tmpSeq , "typeCode" : typeCode}),
					                        type:'POST',
					                        dataType : "json",
					                        contentType  : "application/json",
					                    }).done(function(resultData,status,jqXhr){
					                    	if(kpcUtil.kpcApiSuccessHandling("",resultData,false)){
					                    		kpcUtil.customAlert("승인 되었습니다.");
					                    		$(".modal").modal("toggle");
					                    		table.fnFilter();
					                    	}
					                    }).fail(function(e){
					                		kpcUtil.errorHandling(e);
					              	    });
				   					}
				   				}
				   			}
				   		   ,{
				   				target : ".btnReject",
				   				eventType : "click",
				   				callBack : function (){
				   					
				   					kpcPopupUtil.openPromptPop({
				   						confirmMsg : "반려 사유를 입력해주세요."
				   					   ,confirmTitle : "반려"
				   					   ,promptCallback : function (desc){
					   						$.ajax({
						                        url: "/api/approval/reject",
						                        data: JSON.stringify({"seq" : seq , "tmpSeq" : tmpSeq , "desc" : desc}),
						                        type:'POST',
						                        dataType : "json",
						                        contentType  : "application/json",
						                    }).done(function(data,status,jqXhr){
						                    	if(kpcUtil.successHandlingToMsg("",data,false,"반려 처리 되었습니다.")){
						                    		$(".modal").modal("toggle");
						                    		table.fnFilter();
						                    	}
						                    }).fail(function(e){
						                		kpcUtil.errorHandling(e);
						              	    });				   						   
				   					   }
				   					});
				   					

				   				}
				   			}
          		   		   ,{
           		   				target : ".btnUpt",
           		   				eventType : "click",
           		   				callBack : function (){
           		                   	if($("#couponUpdForm #expireDaysType").val() != "" && $("#couponUpdForm #expireDays").val() == ""){
           		                   		kpcUtil.customAlert("유효기간을 설정 하세요.");
           		                   		return false;
           		                   	}
           		                   	if($("#couponUpdForm #expireDaysType").val() == "" && $("#couponUpdForm #expireDays").val() != ""){
           		                   		kpcUtil.customAlert("유효기간 타입을 설정 하세요.");
           		                   		return false;
           		                   	}           		   					
           		   					if($("#couponUpdForm").valid() && kpcUtil.confirm("수정 후 재승인요청 하시겠습니까?") ){
           		                    	if($("#couponUpdForm #expireDaysType").val() == "" && ($("#couponUpdForm #expireDays").val() == "" || $("#expireDays").val() == "0") ){
           		                    		kpcUtil.customAlert("유효기간을 설정하지 않아 자동 설정 됩니다.(1년)");
           		                    		$("#couponUpdForm #expireDaysType").val("DATE-0003").attr("selected" , "selected").change();
           		                    		$("#couponUpdForm #expireDays").val("1");
           		                    	}
           		                    	
           		                    	var menuId = "CPN-1001";
           		                    	// 승인자 선택
           		                    	kpcPopupUtil.openApprListPop({
           		                    		 menuId : menuId 
           		                    		,callBack : function (data){
           		                    			var updApprEmpId = $("input[name=empList]:checked").attr("empId");
           		   			   					if(typeof updApprEmpId === "undefined"){
           		   			   						kpcUtil.customAlert("승인자를 선택해주세요.");
           		   			   						return false;
           		   			   					} else {
           		   			   						var jsonData = $("#couponUpdForm").serializeJsonObject();
           		   			   						jsonData["apprEmpId"] = updApprEmpId;
           		   			   						jsonData["menuId"] = menuId;
           		   			   						jsonData["tmpSeq"] = tmpSeq;
           		   			   						jsonData["seq"] = seq;
           	           		                    	console.log(jsonData);
           		           		             		$.ajax({
           			           		         			url: "/api/approval/kcon/approvals/reject/reApproval",
           			           		         			data: JSON.stringify(jsonData),
           			           		         			type:'POST',
           			           		         			dataType : "json",
           			           		         			contentType  : "application/json",
           		           		         			}).done(function (data){
           		       		                    		if(kpcUtil.successHandlingToMsg("#couponUpdForm",data,true,"승인 요청 되었습니다.")){
           		       		                    			$(".modal").modal('toggle');
           		       		                    			table.fnFilter();
           		       		                    		}           		       		                        	
           		           		         			}).fail(function (e){
           		           		         				kpcUtil.errorHandling(e);
           		           		         			});              		   			   						
           		   			   						
           		   			   					}
           		                    		}
           		                    	});           		                    	
        		                    	
           		   					}
           		   				}
           		   			}		   		   
			               ,{
			            	   target : ".modal",
			            	   eventType : "shown.bs.modal",
			            	   callBack : function (){
			                        $.ajax({
				                           url: "/api/approval/kcon/approvals/kconTmp",
				                           data: "tmpSeq=" + tmpSeq,
				                           type:'GET',
				                           dataType : "json",
			                    	}).done(function(resultData,sts,jqXhr){
			                    		if(resultData["apprStatus"] == "ARST-0003" && resultData["apprTypeCode"] == "APPR-0500" && reqEmpId == "{{session['empId']}}"){
		           		   					setUpdDataFormat(resultData);
		           		            		$("#couponUpdForm input[name=typeCode]").change(function (){
		           		        				if($(this).val() == "PRTY-0001"){
		           		        					settypeUpdDetail(typeDetailCPCData);
		           		        				}else{
		           		        					settypeUpdDetail(typeDetailCPTData);
		           		        				}
		           		            		});            			           		   					
			                    		} else {
			                    			kpcUtil.setFormData("#detailForm" , resultData);
			                         		$("#detailForm #typeCodeNm").text(resultData.typeName);
			                         		$("#detailForm #typeDetailNm").text(resultData.typeDetailName);
			                         		setDetailDataFormat(resultData);
			                    		}
			                        }).fail(function(e){
			                	    	kpcUtil.errorHandling(e);
			              	        });			            			   
			            	   }
			               }]
				   		});            		        			
                    	
                    })  
                    .dataTable(
                        {
                            "processing": true,
                            "serverSide": true,
                            "ajax": {
                                "url": "/api/approval/kcon/approvals",
                                "async" : "true",
                                "data": function (parameter) {
                                    parameter.formData = $("#searchForm").serializeObject();
                                },
                                "error" : function (e){kpcUtil.sessionExpire(e);}
                            },
                            "ordering": false,
                            "drawCallback": function (settings) {
                                for (var i = 0, iLen = settings.aiDisplay.length; i < iLen; i++) {
                                    $('td:eq(0)', settings.aoData[settings.aiDisplay[i]].nTr).html(i + 1 + settings._iDisplayStart);
                                    settings.json.data[i].rownum = i + 1 + settings._iDisplayStart;
                                }
                                $(".selGroup").prop("checked" , false); // 전체 체크 박스 해제
                            },
                            columns: [
                                {data: "rownum", defaultContent: "", width : 80, className: "column-align-right"},      // 순번
                                {
                                	orderable : false,
                                	className : "checkboxes column-align-center",
                                	render : function (data, type, full, meta){
                                		var checkbox_html ='<label class="mt-checkbox mt-checkbox-single mt-checkbox-outline">'
                                						  +'<input type="checkbox" class="selCheckboxes" name="selFlag" '
                                						  +' seq="'+full.seq+'"'
                                						  +' tmpSeq="'+full.tmpSeq +'"' 
                                						  +' status="'+full.status +'"' 
                                						  + '>'
                                		                  +'<span></span>'
                                		                  +'</label>';
                                		return checkbox_html;
                                	}
                                }, // 선택
                                {data: "statusNm", defaultContent: "", className: "column-align-center"}, // 상태 
                                {data: "typeCodeNm", defaultContent: "", className: "column-align-center"}, // 처리구분 
                                {
                                  	data : "createDt" ,
  	                                defaultContent: "",
  	                                width : 90,
  	                                className: "column-align-center" ,
  	                                render : function (data, type , full , meta){
  	                                	return kpcUtil.setDateFormat(full.createDt , "YYYY-MM-DD");
  	                                }
                                },  // 신청일         
                                {
                                  	data : "updateDt" ,
  	                                defaultContent: "",
  	                                width : 90,
  	                                className: "column-align-center" ,
  	                                render : function (data, type , full , meta){
  	                                	return kpcUtil.setDateFormat(full.updateDt , "YYYY-MM-DD");
  	                                }
                                },  // 처리일   
                                {data: "typeNm", defaultContent: "", className: "column-align-center"}, // 상품유형
                                {data: "typeDetailNm", defaultContent: "", className: "column-align-center"}, // 상품유형상세
                                {data: "title", defaultContent: "", className: "column-align-center"}, // KCON 상품명
                                {data: "nameReqEmpNm", defaultContent: "", className: "column-align-center"}, // 신청자
                                {data: "apprEmpNm", defaultContent: "", className: "column-align-center"}, // 승인자
                                {
                                  	data : "detail" ,
  	                                defaultContent: "",
  	                                width : 90,
  	                                className: "column-align-center" ,
  	                                render : function (data, type , full , meta){
  	                                 	// 상세보기 버튼
  	                                    var detailButton ='<button class="btn btn-sm green btn-outline filter-submit margin-bottom-0 det"';
  	                                		detailButton +='reqEmpId="'  + full.reqEmpId+'"';
  	                                		detailButton +='apprEmpId="' + full.apprEmpId+'"';
  	                                		detailButton +='seq="'       + full.seq+'"';
  	                                		detailButton +='tmpSeq="'    + full.tmpSeq+'"';
  	                                		detailButton +='typeCode="'  + full.typeCode+'"';
  	                                		detailButton +='status="'    + full.status+'" >';
  	                                 		detailButton +='<i class="fa fa-search"></i>상세 보기</button>';  	                                	
  	                                	return detailButton;
  	                                }
                                },  // 상세보기   

                            ],
                            buttons: [
/*                                 {extend:'excel', className:'btn yellow btn-outline', footer: true}, */
                                {% if admin_view.pageAuth["insFlag"] == "1" %}
                                {
                                    text:'승인',
                                    className:'btn green btn-outline',
                                    action: function (e, dt, node, config) {
                                    	var dataArray = new Array();
                                    	table.find("tbody >tr").each(function (){
                                    		var object = new Object();
                                    		var checked = $(this).find("td").eq(1).find("input").prop("checked");
                                    		var status = $(this).find("td").eq(1).find("input").attr("status");
                                        	if(checked && status == "ARST-0001"){
                                        		object["seq"] = $(this).find("td").eq(1).find("input").attr("seq"); 
                                        		object["tmpSeq"] = $(this).find("td").eq(1).find("input").attr("tmpSeq");
                                        		object["typeCode"] = $(this).find("td").eq(1).find("input").attr("typeCode");
                                        		dataArray.push(object);
                                        	}
                                    	});        
                                    	if(dataArray.length > 0){
	                                   		if(kpcUtil.confirm("승인 하시겠습니까?")){
	       				   						$.ajax({
	       					                        url: "/api/approval/kcon/approvals/approvalArray",
	       					                        data: JSON.stringify(dataArray),
	       					                        type:'POST',
	       					                        dataType : "json",
	       					                        contentType  : "application/json",
	       					                    }).done(function(resultData,status,jqXhr){
	       					                    	if(kpcUtil.kpcApiSuccessHandling("",resultData,false)){
	       					                    		kpcUtil.customAlert("승인 되었습니다.");
	       					                    		table.fnFilter();
	       					                    	}
	       					                    }).fail(function(e){
	       					                		kpcUtil.errorHandling(e);
	       					              	    });
	                                   		}
                                    	}else {
                                    		kpcUtil.customAlert("승인처리 하실 요청건을 선택하세요.");
                                    	}
                                    }
                                },
                                {% endif %}
                                {% if admin_view.pageAuth["insFlag"] == "1" %}
                                {
                                    text:'반려',
                                    className:'btn green btn-outline',
                                    action: function (e, dt, node, config) {
                                    	var dataArray = new Array();
                                    	table.find("tbody >tr").each(function (){
                                    		var object = new Object();
                                    		var checked = $(this).find("td").eq(1).find("input").prop("checked");
                                    		var status = $(this).find("td").eq(1).find("input").attr("status");
                                        	if(checked && status == "ARST-0001"){
                                        		object["seq"] = $(this).find("td").eq(1).find("input").attr("seq"); 
                                        		object["tmpSeq"] = $(this).find("td").eq(1).find("input").attr("tmpSeq");
                                        		dataArray.push(object);
                                        	}
                                    	});                                    	
                                    	if(dataArray.length > 0){
	                                   		if(kpcUtil.confirm("반려 하시겠습니까?")){
	       				   						$.ajax({
	       					                        url: "/api/approval/kcon/approvals/rejectArray",
	       					                        data: JSON.stringify(dataArray),
	       					                        type:'POST',
	       					                        dataType : "json",
	       					                        contentType  : "application/json",
	       					                    }).done(function(resultData,status,jqXhr){
	       					                    	if(kpcUtil.kpcApiSuccessHandling("",resultData,false)){
	       					                    		kpcUtil.customAlert("반려 되었습니다.");
	       					                    		table.fnFilter();
	       					                    	}
	       					                    }).fail(function(e){
	       					                		kpcUtil.errorHandling(e);
	       					              	    });
	                                   		}
                                    	}else {
                                    		kpcUtil.customAlert("반려처리 하실 요청건을 선택하세요.");
                                    	}
                                    }
                                },
                                {% endif %}                                
								{
                                    text:'조회',
                                    className:'btn green btn-outline',
                                    action: function (e, dt, node, config) {
                                        table.fnFilter();
                                    }
                                }
                            ],
                            "lengthMenu": [[10, 20, 30, 50, 200], [10, 20, 30, 50, 200]],
                            "pageLength": 10,
                            "dom": "<'row' <'col-md-8 col-sm-12'l><'col-md-4 col-sm-12'B>><'table-scrollable'tr><'row'<'col-md-6 col-sm-6'i><'col-md-6 col-sm-6'p>>",
                            responsive: true,
                            "language": {
                                "aria": {
                                    "sortAscending": ": activate to sort column ascending",
                                    "sortDescending": ": activate to sort column descending"
                                },
                                "info":"Total Record: _TOTAL_ Page : _PAGE_ / _PAGES_ ",
                                "emptyTable": "조회된 자료가 없습니다.",
                                "infoEmpty": "조회된 자료가 없습니다.",
                                "lengthMenu": "_MENU_",
                                "zeroRecords": "조회된 자료가 없습니다."
                            },
                        }
                    );
            }
            
            var setDetailDataFormat = function (resultData){
                   var expireDaysType = resultData.expireDaysType;
                   var expireDaysTypeName = "";
                   if(expireDaysType =='DATE-0001'){
                   	    expireDaysTypeName ='발행일로부터' + resultData.expireDays +' 일'  
                   }else if(expireDaysType =='DATE-0002'){
                   	    expireDaysTypeName ='발행일로부터' + resultData.expireDays +' 개월'    	                                		
                   }else if(expireDaysType =='DATE-0003'){
                       expireDaysTypeName ='발행일로부터' + resultData.expireDays +' 년'    	                                		
                   }
                   $("#expireDaysTypeName").text(expireDaysTypeName);            	
            }
            
            var setUpdEvents = function (){
           		$("select[name=expireDaysType]").change(function (){
           			if($(this).val() == "DATE-0001"){
           				$("#dateTypeText").html("&nbsp;일");
           			}else if($(this).val() == "DATE-0002"){
           				$("#dateTypeText").html("&nbsp;개월");
           			}else if($(this).val() == "DATE-0003"){
           				$("#dateTypeText").html("&nbsp;년");
           			}
           		});            	
            }            
            
            var setUpdFormValidate = function (){
                $("#couponUpdForm").validate({
                    errorElement:'span', //default input error message container
                    errorClass:'help-block help-block-error', // default input error message class
                    rules: {
                    	name : {
                            required : true,
                        },
                        amount : {
                            required : true,
                        	number : true,
                        },
                    },
                    messages : {
                    	name : {
                            required : "상품명을 입력해주세요.",
                        },
                        amount : {
                            required : "권종을 선택해주세요.",
                        },
                    },
                    invalidHandler:function (form,validator){
                    	if(validator.numberOfInvalids()){
                    		kpcUtil.customAlert("필수항목이 입력되지 않았습니다.");
                    	}
                    },
                    errorPlacement : function (error , element){
                    	var icon = $(element).parent(".input-icon").children('i');
                    	icon.removeClass('fa-check').addClass("fa-warning");
                    	icon.attr("data-original-title" , error.text()).tooltip({"container" : "body"});
                    },
                    highlight: function (element) { // hightlight error inputs
                       	$(element).closest('.form-group').addClass('has-error'); // set error class to the control group
                    }, 
                    success : function (label,element){
                    	var icon = $(element).parent(".input-icon").children('i');
                    	$(element).closest(".form-group").removeClass("has-error").addClass("has-success");
                    	icon.removeClass('fa-warning').addClass("fa-check");
                    },
                });

            }             
            
            var setUpdDataFormat = function (resultData){
            	$("#couponUpdForm #usage").select2();
      			kpcUtil.setSelectBoxData({
            		target : [
            			 "#expireDaysType"
            		], 
            		apiUrl : "/api/systemMng/common/commonCodeList",
            		params : {type :'DATE'},
            		type   : "GET",
            		option : {width : 80},	
            		callBack : function (data,target,option){
            			for(var idx in data){
            				for(var idx2 in data[idx].resultList){
	            				$(target[idx]).append($("<option></option>")
	            						.attr("value" , data[idx].resultList[idx2].code)
	            						.text(data[idx].resultList[idx2].codeName));
            				}
            				$(target[idx]).select2(option);       
            			}
						setUpdFormValidate();
  						setUpdEvents();			   
  						kpcUtil.setFormData("#couponUpdForm" , resultData);            			
            			if(resultData["expireDaysType"] == "PRTY-0001"){
	            			settypeUpdDetail(typeDetailCPCData);   
            			}else {
            				settypeUpdDetail(typeDetailCPTData);
            			}
            		}
            	});            	
            }
            
            var getDetailBrochureData = function (target,id){
                $.ajax({
                    url: "/api/coupon/brochures/brochure",
                    data: "id=" + id,
                    type: 'GET',
                    dataType : "json",
             	}).done(function(resultData,status,jqXhr){
             		$("#typeCodeNm").text(resultData.typeName);
             		$("#typeDetailNm").text(resultData.typeDetailName);
             		$("#amount").text(resultData.amount);
                 }).fail(function(e){
         	    	kpcUtil.errorHandling(e);
       	         });              	
            }          
            var getBrochureData = function (id){
                $.ajax({
                    url: "/api/coupon/brochures/brochure",
                    data: "id=" + id,
                    type: 'GET',
                    dataType : "json",
             	}).done(function(resultData,status,jqXhr){
             		kpcUtil.setFormData("#detailForm", resultData);
             		$("#detailForm #typeCodeNm").text(resultData.typeName);
             		$("#detailForm #typeDetailNm").text(resultData.typeDetailName);
                }).fail(function(e){
         	    	kpcUtil.errorHandling(e);
     	        });              	
            }               

            var setPageEvents = function (){
     	
            	// 선택 예외 처리를 위한 공통 미사용
            	// kpcUtil.setAllChecked(".selGroup");
		    	$(".selGroup").change(function (){
		    		var checked = $(this).is(":checked");
		        	$($(this).attr("data-set")).each(function (){
		        		var tagName = $(this).get(0).tagName;
		        		if (checked && (tagName === "TD" || tagName === "INPUT")){
		        			$(this).each(function (){
                            	if($(this).attr("status") != "ARST-0001"){
                            		$(this).prop("checked" , false);
                            	}else {
				        			$(this).prop("checked" , true);
                            	}		        				
		        			});
		        		} else {
		        			$(this).prop("checked" , false);
		        		}
		        	});
		        });            	
    			// 조회 이벤트
            	kpcUtil.serachFormEvent({
            		selects : "#searchForm select",
            		inputs : "#searchForm input",
            		callback : function (){
		
            			table.fnFilter();
            		}
            	});
    			
            }

            return {
                init : function (){
                	setDatePicker();
                	setCommonCode();
                    setPageEvents();
                }
            }
        }

        $(document).ready(function () {
            userMenuMng_inq().init();
        });
    </script>
{% endblock %}