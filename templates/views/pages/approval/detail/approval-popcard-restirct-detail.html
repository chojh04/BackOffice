<!-- extend base layout -->
{% extends "views/master.html" %}

{% block body %}
<div class="right_col" role="main">
	<div>
		<div class="page-title">
            <div class="title_left">
            {% if admin_view.menuType == "request" %}
                <h3>승인 신청내역 상세보기</h3>
                <h5><span class="red">[홈 > 승인 관리 > 승인  신청내역 조회 > 승인 신청내역 상세보기]</span></h5>
            {% elif admin_view.menuType == "answer" %}
                <h3>승인 결제내역 상세보기</h3>
                <h5><span class="red">[홈 > 승인 관리 > 승인  결제내역 조회 > 승인 결제내역 상세보기]</span></h5>
            {% endif %}    
            </div>
        </div>
	
	<div class="clearfix"></div>

	<div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="form">
	                    <div class="col-md-12 col-sm-12 col-xs-12">
	                        <div class="col-md-12 col-sm-12 col-xs-12 form-group" style="margin-top:30px">
	                            <label class="control-label col-md-3 col-sm-3 col-xs-12"><b style="font-size:14px;">POP카드 사용제한 해제 상세정보</b></label>
	                        </div>
	                    </div>
	                    <div>
	                    <form id="searchForm" name="searchForm">
	                    	<input type="hidden" id="seq" name="seq"/>
	                    	<input type="hidden" id="contentSeq" name="contentSeq" />
	                    	<input type="hidden" id="cardNumber" name="cardNumber"/>
	                    	<input type="hidden" id="giftNo" name="giftNo" />
	                    	<input type="hidden" id="restrictYN" name="restrictYN" value="Y" />                  	
	                    </form>
	                    <form id="cardData">
	                        <div class="col-md-12 col-sm-12 col-xs-12">
	                            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
	                                <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">카드번호</label>
	                                <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                                	<span name="cardNumber" class="span-vertical-middle"></span>	                                	
	                                </div>
	                            </div>	                            
	                            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
	                                <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">관리번호</label>
	                                <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                                	<span name="giftNo" class="span-vertical-middle"></span>
	                                </div>
	                            </div>
	                            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
	                                <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">발행일</label>
	                                <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                                	<span name="createDate" class="span-vertical-middle"  isDateField="true"></span>
	                                </div>
	                            </div>
	                            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
	                                <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">카드잔액</label>
	                                <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                                	<span name="currentAmount" class="span-vertical-middle" isNumber="true"></span>
	                                </div>
	                            </div>
	                             <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
	                                <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">상태</label>
	                                <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                                	<span name="status" class="span-vertical-middle"></span>
	                                </div>
	                            </div>
	                             <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
	                                <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">제한여부</label>
	                                <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                                	<span name="restrict" class="span-vertical-middle"><font color="red">Y</font></span>
	                                </div>
	                            </div>	                           
	                            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
	                                <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">판매처</label>
	                                <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                                	<span name="saleMerchantName" class="span-vertical-middle"></span>
	                                </div>
	                            </div>
	                           
                            </div>
						</div>
						</form>
						<form id="apprReqData">
						<div class="x_content reqMemoDiv" style="margin-top:0px; padding-bottom:10px;"><hr style="margin-top:10px;margin-bottom:11px"></div>
						<div class="col-md-12 col-sm-12 col-xs-12 reqMemoDiv">
							<div class="col-lg-4 col-md-12 col-sm-12 col-xs-12 form-group">
	                            <label id="apprReqMemoTitle" class="col-lg-3 control-label">해제 사유</label>
	                            <div class="col-lg-9 form-inline">
	                            	<span id="restrictDesc" class="span-vertical-middle"></span>
	                            </div>
	                        </div>
						</div>
						<div class="x_content" style="margin-top:0px; padding-bottom:10px;"><hr style="margin-top:10px;margin-bottom:10px"></div>
	                    <div class="col-md-12 col-sm-12 col-xs-12">
	                        <div class="col-md-12 col-sm-12 col-xs-12 form-group ">
	                            <label class="control-label col-md-3 col-sm-3 col-xs-12"><b>승인 상세정보</b></label>
	                        </div>
	                    </div>
	                    </form>
	                    <form id="apprResData">
						<div class="col-md-12 col-sm-12 col-xs-12">
	                        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
	                        {% if admin_view.menuType == "request" %}
	                            <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">승인자</label>
	                            <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                            	<span id="apprEmpName" class="span-vertical-middle"></span>
	                            </div>
                            {% elif admin_view.menuType == "answer" %}
	                            <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">신청자</label>
	                            <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                            	<span id="reqEmpName" class="span-vertical-middle"></span>
	                            </div>
                            {% endif %}
	                        </div>
	                        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
	                            <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">승인상태</label>
	                            <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
									<span id="apprStatusName" style="padding-left:12px; padding-top:6px; padding-bottom:6px"></span>
	                            	<span id="apprTypeCodeName" style="padding-top:6px; padding-bottom:6px" ></span>
	                            </div>
	                        </div>
	                        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
	                            <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">신청일</label>
	                            <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                            	<span id="reqDate" class="span-vertical-middle" isDateField="true"></span>
	                            </div>
	                        </div>
	                        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
	                            <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">처리일</label>
	                            <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                            	<span id="apprDate" class="span-vertical-middle" isDateField="true"></span>
	                            </div>
	                        </div>	         
	                       
	                        {% if(admin_view.status=="ARST-0003") %}       
	                        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group apprMemoDiv">
	                            <label class="col-lg-3 col-md-4 col-sm-5 col-xs-12 control-label">승인 반려사유</label>
	                            <div class="col-lg-9 col-md-8 col-sm-7 col-xs-12 form-inline">
	                            	<span id="apprMemo" class="span-vertical-middle"></span>
	                            </div>
	                        </div>	  
	                        {% endif%}          
						</div>
						</form>
	                    <br />
	                    <div class="column-align-right">
	                    	{% if (admin_view.pageAuth["selFlag"] == "1") and (admin_view.menuType == "request") and (admin_view.status == "ARST-0001") %}
	                    	<button type="button" id="updateApprovalRequestBtn" class="dt-button btn green btn-outline">수정</button>
	                    	<button type="button" id="cancelApprovalRequestBtn" class="dt-button btn green btn-outline">취소</button>	  
	                    	{% elif (admin_view.pageAuth["selFlag"] == "1") and (admin_view.menuType == "request") and (admin_view.status == "ARST-0003" or (admin_view.status == "ARST-0004")) %}
	                    	<button type="button" id="reApprovalRequestBtn" class="dt-button btn green btn-outline">재승인</button>
							{% endif %}
	                    	{% if (admin_view.pageAuth["apprFlag"] == "1") and admin_view.menuType == "answer" and (admin_view.status == "ARST-0001") %}   
							<button type="button" id="approveApprovalInfo" class="dt-button btn green btn-outline">승인</button>                        
							<button type="button" id="rejectApprovalInfo" class="dt-button btn green btn-outline">반려</button>
							{% endif %}
							{% if admin_view.pageAuth["selFlag"] == "1" %}
							<button type="button" id="returnApprovalList" class="dt-button btn red btn-outline">목록</button>
							{% endif %}
	                    </div>
                    </div>
                </div>
            </div>
        </div>
	</div>
</div>

<!-- 반려사유 모달 -->
<div id="rejectApprovalModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="test" aria-hidden="true">
	<div class="modal-dialog" style="width:400px">
		<div class="modal-content">
			
			<div class="modal-header" style="text-align: center">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
				<h4 class="modal-title">승인 반려사유 입력</h4>
			</div>
			<div class="modal-body" style="text-align: center">
				<div id="testId" class="form-horizontal" role="form">
					<div class="form-group">
						<span>승인 반려사유를 입력해주세요.</span>
					</div>
					<div class="form-group" style="margin-bottom: 0px">
						<div class="col-sm-12">
							<input type="text" class="form-control" id="rejectApprMemo" name="rejectApprMemo" placeholder="한글 기준 (100자 이내) 입력">
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer"  style="text-align: center">
				<button id="rejectApprovalBtn" type="button" class="btn btn-primary">확인</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
			</div>
		</div>
	</div>
</div>

{% endblock %}
	{% include 'views/pages/common/approval/popup/approval-request-create-modal.html' %}
{% block tail %}
    <!-- datatable lib-->
    <script src="/bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="/bower_components/datatables.net-bs/js/dataTables.bootstrap.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.colVis.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="/bower_components/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="/bower_components/jszip/dist/jszip.min.js"></script>
    <script src="/bower_components/pdfmake/build/pdfmake.min.js"></script>
    <script src="/bower_components/pdfmake/build/vfs_fonts.js"></script>
    <script src="/assets/js/card/card.js"></script>
    <script src="/assets/js/approval/approval.js"></script>

    <script type="text/javascript">

    var cardDetail = function () {

    	var seq = "{{admin_view.seq}}"
    	var apprReqData, apprResData;
    	var rejectApprovalSeqList = [];
    	
    	//사용제한 요청 정보 조회
    	var getCardInfo = function() {    		
    		$.ajax({
                url: "/api/approvals/detail/"+seq,
                type:'GET',
                dataType : "json",
                contentType  : "application/json",
            }).done(function(result){
            	
            	if (result.status === 200) {
            		
	            	approvalInfo = result.data.approvalInfo        	
	            	
	            	apprReqData = result.data.content;
	            	apprResData = result.data.approvalInfo;
	     
	            	
	            	//승인요청 정보 set
	            	kpcUtil.setFormData("#apprReqData",apprReqData);
	            	
	            	$("#contentSeq").val(approvalInfo.contentSeq);
	            	$("#seq").val(approvalInfo.seq);
	            	//카드정보 set
	            	cardInfo(apprReqData.cardNumber);
	            	kpcUtil.setFormData("#apprResData",apprResData);
	            	
	            	//진행상태에 따른 메시지 표시
                	if(apprResData.status == "ARST-0001") {
                		$("#apprStatusName").text("최종 승인대기");
                	} else if (apprResData.status == "ARST-0002") {
                		$("#apprStatusName").text("최종 승인완료");
                	} else if (apprResData.status == "ARST-0003") {
                		$("#apprStatusName").text("최종 승인반려");
                		$("#apprStatusName").addClass("red");
                		$("#contentSeq").val(0);
    	            	$("#seq").val(0);
                	} else if (apprResData.status == "ARST-0004") {
                		$("#apprStatusName").text("승인 요청취소");
                		$("#contentSeq").val(0);
    	            	$("#seq").val(0);
                	} else {
                		$("#apprStatusName").text("");
                	}
	            	
	            	if(apprResData.apprDate=="") $("#apprDate").text("-");            	

            	}
				else if (result.status == 500) {
					kpcUtil.customAlert(result.message);
				}
            	
            }).fail(function(e){
        		kpcUtil.errorHandling(e);
      	    });
    	}
    	
    	//카드 기본정보 조회
    	 var cardInfo = function (cardNumber){
             $.ajax({
                 url: "/api/card/popCard",
                 data: { cardNumber : cardNumber, target : "1" },
                 type: 'GET',
                 dataType : "json",
                 contentType  : "application/json",
                 async : true,
                 success: function(data){	                	   
              	   if(kpcUtil.kpcApiSuccessHandling("#couponUpdForm",data,false)){
					kpcUtil.setFormData("#cardData",data);
					kpcUtil.setFormData("#searchForm",data);
					$("[name='cardNumber']").text(cardNumber);
					$("#cardNumber").val(cardNumber);
              	   }
                 },
                 error : function(e){
                 	kpcUtil.errorHandling(e);
                 }
             });
         }
    	
        var setPageEvents = function () {
        	
       
        	{% if admin_view.menuType == "request" %}    		
	        	//요청 취소 버튼
	        	$("#cancelApprovalRequestBtn").click(function () {	        		
	        		if (approvalInfo.status === "ARST-0001") {
		        		if (kpcUtil.confirm("승인요청을 취소 하시겠습니까?")) {
		        			 
		           			$.ajax({
		   	        			url: "/api/approval/cancel",
		   	        			data: JSON.stringify(seq),
		   	        			type:'PUT',
		   	        			dataType : "json",
		   	        			contentType  : "application/json"
		   	        			}).done(function(resultData,status,jqXhr){
		   	        				if (resultData.status == 200) {
		                       			kpcUtil.customAlert("승인요청이 취소 되었습니다.");
		   								approvalInfo = null;
		   								location.href ="/approval/request";
		                       		}
		                           	else if (resultData.status == 500) {
		   	                        		alert(resultData.message);
		                           	}
		   	        			}).fail(function(e){
		   	        				kpcUtil.errorHandling(e);
		           				});
		           		}
	        		}
	        		else {
              			kpcUtil.customAlert("승인 취소 할 수 없는 요청 정보입니다.");
	        		}
	        	})
	        	$("#reApprovalRequestBtn").click(function(){
	        		if(confirm('재승인 요청 하시겠습니까?')){	        			
	        			document.location.href='/card/popCard/popCardMng?cardNumber='+apprReqData.cardNumber;
	        		}
	        	});
	        	$("#updateApprovalRequestBtn").click(function(){
	        		if(confirm('수정 요청 하시겠습니까?')){	        			
	        			document.location.href='/card/popCard/popCardMng?cardNumber='+apprReqData.cardNumber+"&apprSeq="+seq+"&contentSeq="+$("#contentSeq").val();
	        		}
	        	});
        	{% elif admin_view.menuType == "answer" %}
	        	$("#approveApprovalInfo").click(function (){	        		
	        		var dataArray = new Array();
					if(approvalInfo.status === "ARST-0001") {
						result = {
								"seq" : apprResData.seq,
								"contentSeq" : apprResData.contentSeq,
								"workType" : apprResData.workType,
								"reqType" : apprResData.reqType,
								"status" : apprResData.status
						}
						dataArray.push(result)
					}
	         		
	        		if(kpcUtil.confirm("승인 처리 하시겠습니까?")){
		        		$.ajax({
		        			url: "/api/approval/approve",
		        			data: JSON.stringify(dataArray),
		        			type:'POST',
		        			dataType : "json",
		        			contentType  : "application/json"
		        			}).done(function(resultData,status,jqXhr){
		        				if (resultData.status == 200) {
		        					//문자보내기
		                   			notiData = {
		        								"workType" : approvalInfo.workType,
		        								"reqType" : approvalInfo.reqType,
		        								"reqEmpId" : approvalInfo.reqEmpId
		        							}
		        					approval.approvalAnswerSendSms(notiData, "approve");
		        					
	                    			kpcUtil.customAlert("승인 처리 되었습니다.");
									approvalInfo = null;
									location.href ="/approval/answer";
	                    		}
	                        	else if (resultData.status == 500) {
		                        		alert(resultData.message);
	                        	}
		        			}).fail(function(e){
		        				kpcUtil.errorHandling(e);
	        				});
	        		}
	        		
	        		
	       		});
        	
	        	//승인 반려 처리 이벤트1 (모달 띄우기)
	        	$("#rejectApprovalInfo").click(function (){
	        		//API가 다건도 처리 가능하기 때문에 배열 사용
	        		var sequenceList = [];
				
					//현재 승인요청 건인지 확인
					if(approvalInfo.status === "ARST-0001") {
						sequenceList.push(approvalInfo.seq)
						
						if(kpcUtil.confirm("승인 반려 처리하시겠습니까?")){
							rejectApprovalSeqList = sequenceList;
							$("#rejectApprovalModal").modal("show");
		           		}
					}
					else {
						kpcUtil.alert("반려할수 없는 승인요청입니다.");
					}
	        	});
        		        	
	        	
	        	//승인 반쳐 처리 이벤트2 (모달 뜬 이후 처리)
				$("#rejectApprovalBtn").click(function (){
					rejectList = {
							"sequenceList" : rejectApprovalSeqList,
							"apprMemo" : $("#rejectApprMemo").val() 
					}
					
					$.ajax({
						url: "/api/approvals/response/rejection",
						data: JSON.stringify(rejectList),
						type:'POST',
						dataType : "json",
						contentType  : "application/json"
					}).done(function(resultData,status,jqXhr){
												
	               		if (resultData.status == 200) {
	    					//문자보내기
	               			notiData = {
	    								"workType" : approvalInfo.workType,
	    								"reqType" : approvalInfo.reqType,
	    								"reqEmpId" : approvalInfo.reqEmpId
	    							}
	    					approval.approvalAnswerSendSms(notiData, "reject");
	               			kpcUtil.customAlert("반려 처리 되었습니다.");
							rejectApprovalSeqList = []
							$("#rejectApprovalModal").modal("hide")
							location.href ="/approval/answer";
	               		}
	                   	else if (resultData.status == 500) {
	                       		alert(resultData.message);
	                   	}
					}).fail(function(e){
						kpcUtil.errorHandling(e);
						$("#rejectApprovalModal").modal("hide")
					});
	 			})

	 			//모달이 닫힐 때 모달 값 초기화
	 			$("#rejectApprovalModal").on("hidden.bs.modal", function(e) {
	 				$("#rejectApprMemo").val(); 
	 			})
	 			
				$("#rejectApprovalModal").on("shown.bs.modal", function(e) {
					$("#rejectApprMemo").focus(); 
				})
	 			
 			{% endif %}

 			
        	//목록 화면으로 이동
        	$("#returnApprovalList").click(function (){
        		location.href = history.go(-1);
        		/*
	        	{% if admin_view.searchData is not none %}
	        		location.href ="/approval/{{admin_view.menuType}}?"+$("#searchForm").serialize();
				{% else%}
	        		location.href ="/approval/{{admin_view.menuType}}";
	        	{% endif %}
	        	*/
        	})
        }   

        var setServiceBillingCommonCode = function (commonCodes){
        	kpcUtil.setSelectBoxData({
         		target : "#kconStatus", 
         		apiUrl : "/api/systemMng/common/commonCodes",
         		params : {type : 'CONS'},
         		type   : "GET",
         		option : {width : 150},	
         		callBack : function (data,target,option){
        			for(var idx in data.data){
             			if (commonCodes.kconStatus === data.data[idx].code) {
    	        			$(target).text(data.data[idx].codeName);            			
         				}     
        			}
         		}
         	});
        }
        
        return {
            init : function (){
            	getCardInfo();
                setPageEvents();
            }
        }
    }

    $(document).ready(function () {
    	cardDetail().init();    	
    });
    </script>
{% endblock %}
